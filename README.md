# dikom

ROS2-нода для автоматического поиска стеллажей с помощью лидара и вычисления целевой позы для навигации робота.

## Описание алгоритма

Алгоритм работает в несколько этапов для обнаружения стеллажа и вычисления оптимальной позиции для подъезда:

### 1. Получение данных лидара
Нода подписывается на топик с данными лазерного сканера (LaserScan) и сохраняет последнее полученное сообщение для обработки.

### 2. Нормализация данных дальности
Все некорректные значения дальности (None, бесконечные, отрицательные или нулевые) заменяются на максимальную дальность лидара. Это необходимо для корректной обработки данных.

### 3. Вычисление разностей между соседними лучами
Для каждого луча вычисляется разность с соседним лучом. Это позволяет обнаружить резкие изменения дальности, которые характерны для краёв ножек стеллажа.

### 4. Поиск краёв ножек
Алгоритм ищет пары индексов (начало и конец), где:
- **Вход на ножку**: разность дальности резко уменьшается (отрицательный скачок больше порога)
- **Выход с ножки**: разность дальности резко увеличивается (положительный скачок больше порога)

Между входом и выходом должна быть ножка стеллажа. Ширина ножки ограничена максимальным количеством лучей.

### 5. Вычисление центров ножек
Для каждой найденной пары краёв вычисляется центр ножки в декартовых координатах (x, y) относительно лидара. Центр находится как средняя точка между двумя краями ножки.

### 6. Поиск пары ножек стеллажа
Из всех обнаруженных ножек алгоритм ищет пару, которая соответствует заданным параметрам:
- **Ширина ножек**: должна соответствовать заданной ширине с допуском ±20%
- **Расстояние между ножками**: должно соответствовать заданному шагу стеллажа с допуском ±10%

Логика выбора пары зависит от количества обнаруженных ножек:
- **2 ножки**: проверяется соответствие параметрам
- **3 ножки**: перебираются все возможные пары, выбирается лучшая по критерию минимальной суммарной ошибки
- **4+ ножек**: выбирается пара с минимальным средним расстоянием до робота среди всех подходящих пар

### 7. Вычисление целевой позы
На основе найденной пары ножек вычисляется целевая поза для навигации:
- **Позиция**: центр между ножками, смещённый на заданную глубину входа в направлении перпендикулярном линии между ножками
- **Ориентация**: робот ориентируется перпендикулярно линии между ножками, чтобы заехать между ними

### 8. Отправка цели навигации
Вычисленная поза публикуется в топик `/goal_pose` для системы навигации Nav2.

## Настраиваемые параметры

### Параметры ноды (через ROS2 параметры)

| Параметр | Тип | Значение по умолчанию | Описание |
|----------|-----|----------------------|----------|
| `scan_topic` | string | `"scan"` | Название топика с данными лидара (LaserScan) |
| `diff_threshold` | float | `0.15` | Порог разности дальности для обнаружения краёв ножек (в метрах). Чем больше значение, тем более выраженные скачки будут обнаружены |
| `max_width_rays` | int | `30` | Максимальная ширина ножки в количестве лучей лидара. Ограничивает максимальный размер обнаруживаемых объектов |
| `max_legs` | int | `6` | Максимальное количество ножек для детекции. Если обнаружено больше, берутся первые N ножек |
| `range_max` | float | `0.0` | Максимальная дальность лидара (в метрах). Если установлено в 0.0, используется значение из сообщения LaserScan |

### Параметры сервиса FindRack (в запросе)

| Параметр | Тип | Описание |
|----------|-----|----------|
| `leg_width` | float64 | Ширина ножки стеллажа в метрах. Используется для фильтрации обнаруженных ножек (допуск ±20%) |
| `leg_spacing` | float64 | Расстояние между ножками стеллажа в метрах. Используется для поиска правильной пары ножек (допуск ±10%) |
| `entry_depth` | float64 | Глубина заезда в стеллаж в метрах. Расстояние от центра между ножками до целевой позиции робота |

## Использование

### Запуск ноды
```bash
ros2 run <package_name> test.py
```

### Вызов сервиса поиска стеллажа
```bash
ros2 service call /find_rack amr/srv/FindRack "{leg_width: 0.1, leg_spacing: 0.5, entry_depth: 0.3}"
```

### Настройка параметров через launch-файл
```xml
<node name="rack_finder_service" pkg="<package_name>" exec="test.py">
  <param name="scan_topic" value="scan"/>
  <param name="diff_threshold" value="0.15"/>
  <param name="max_width_rays" value="30"/>
  <param name="max_legs" value="6"/>
  <param name="range_max" value="0.0"/>
</node>
```

## Топики

- **Подписка**: `scan` (или значение параметра `scan_topic`) - данные лидара типа `sensor_msgs/LaserScan`
- **Публикация**: `/goal_pose` - целевая поза для навигации типа `geometry_msgs/PoseStamped`

## Сервисы

- **Сервис**: `find_rack` типа `amr/srv/FindRack`
  - **Запрос**: параметры стеллажа (ширина ножки, расстояние между ножками, глубина входа)
  - **Ответ**: целевая поза, флаг успеха и сообщение о статусе

## Зависимости

- ROS2 (Humble или более новая версия)
- `geometry_msgs`
- `sensor_msgs`
- `tf2_ros`
- `tf2_geometry_msgs`
- Пакет `amr` с определением сервиса `FindRack`
